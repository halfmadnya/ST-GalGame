# 💕 GalGame 恋爱模拟器 - 使用指南

## 项目概述

这是一个基于LLM驱动的GalGame（恋爱模拟游戏）Demo，通过动态提示词系统根据NPC好感度自动调整对话内容和角色态度。

## 核心特性

### 🎮 游戏特性
- **多角色系统**：与不同性格的NPC互动
- **好感度系统**：通过对话影响NPC对你的态度
- **动态对话**：AI根据好感度生成符合角色性格的回应
- **故事进度**：随着游戏推进解锁新角色和剧情

### 🤖 技术特性
- **动态提示词**：基于好感度自动选择合适的提示词
- **角色性格系统**：每个NPC都有独特的性格特征
- **事件触发**：好感度达到特定值时触发特殊事件
- **实时反馈**：对话即时影响好感度

## 快速开始

### 1. 启动游戏

在支持的环境中打开 `index.html`：
- 小白X插件环境
- 支持 `callGenerate` 函数的iframe环境

### 2. 选择角色

游戏启动后，左侧会显示可用角色列表：
- **樱**：青梅竹马，傲娇性格
- **雪**：温柔学姐，体贴关心
- **花**：活泼学妹，需要解锁

点击角色卡片开始对话。

### 3. 开始对话

- 在底部输入框输入你想说的话
- 按回车或点击"发送"按钮
- AI会根据当前好感度生成回应
- 观察好感度变化

### 4. 提升好感度

通过以下方式提升好感度：
- 说符合角色喜好的话
- 关心角色的感受
- 在适当时机表达好感
- 避免说让角色不悦的话

## 角色介绍

### 樱（Sakura）- 青梅竹马
**性格**：傲娇（Tsundere）

**特点**：
- 表面上对你很凶，但内心关心你
- 自尊心强，不善于表达真实感情
- 随着好感度提升会逐渐展现温柔的一面

**好感度阶段**：
- **厌恶（-100~-50）**：完全不想理你，说话很冲
- **冷淡（-49~-10）**：态度冷淡，保持距离
- **普通（-9~20）**：正常的青梅竹马关系
- **友好（21~50）**：开始在意你，偶尔脸红
- **亲密（51~75）**：经常想见你，但还是嘴硬
- **恋人（76~100）**：终于坦率地表达爱意

**攻略提示**：
- 不要被她的傲娇态度吓到
- 要看穿她的口是心非
- 适当的关心会让她很开心
- 不要太直接，要给她台阶下

### 雪（Yuki）- 温柔学姐
**性格**：温柔（Gentle）

**特点**：
- 总是用温暖的笑容对待每个人
- 成熟稳重，善于照顾他人
- 对你特别关心

**好感度阶段**：
- **厌恶（-100~-50）**：感到困惑和受伤
- **冷淡（-49~-10）**：保持礼貌但疏远
- **普通（-9~20）**：正常的学姐学弟关系
- **友好（21~50）**：开始特别关注你
- **亲密（51~75）**：想要更多时间和你在一起
- **恋人（76~100）**：深深爱着你

**攻略提示**：
- 真诚地对待她
- 接受她的关心和照顾
- 也要学会关心她
- 展现你成熟的一面

### 花（Hana）- 活泼学妹
**性格**：活泼（Energetic）

**特点**：
- 充满活力，总是蹦蹦跳跳
- 天真可爱，对你充满崇拜
- 喜欢粘着你

**解锁条件**：
- 与樱的好感度达到30

**好感度阶段**：
- **厌恶（-100~-50）**：伤心哭泣
- **冷淡（-49~-10）**：小心翼翼
- **普通（-9~20）**：正常的学妹学长关系
- **友好（21~50）**：经常找你玩
- **亲密（51~75）**：完全依赖你
- **恋人（76~100）**：想永远和你在一起

**攻略提示**：
- 多陪她玩耍
- 回应她的热情
- 保护她的天真
- 给予她足够的关注

## 好感度系统详解

### 好感度范围
- **-100 到 100**：完整的好感度范围
- **0**：初始状态，中立态度

### 好感度等级

| 等级 | 范围 | 表情 | 态度描述 |
|------|------|------|----------|
| 厌恶 | -100~-50 | 😠 | 非常反感，主动避开 |
| 冷淡 | -49~-10 | 😐 | 保持距离，缺乏热情 |
| 普通 | -9~20 | 🙂 | 正常交流，不亲不疏 |
| 友好 | 21~50 | 😊 | 有好感，愿意互动 |
| 亲密 | 51~75 | 😍 | 明显喜欢，经常想见 |
| 恋人 | 76~100 | 💕 | 深深爱着，想永远在一起 |

### 好感度变化

**增加好感度的行为**：
- 说让角色开心的话
- 关心角色的感受
- 符合角色性格的互动
- 在适当时机表达好感
- 帮助角色解决问题

**减少好感度的行为**：
- 说伤人的话
- 忽视角色的感受
- 不符合角色性格的要求
- 过于冷淡或过于热情（时机不对）
- 做出让角色失望的事

### 好感度显示

游戏界面会实时显示：
- **数值**：当前好感度的具体数值
- **进度条**：可视化的好感度进度
- **颜色**：根据好感度等级变化
  - 红色：厌恶
  - 橙色：冷淡
  - 灰色：普通
  - 蓝色：友好
  - 紫色：亲密
  - 粉色：恋人

## 动态提示词系统

### 工作原理

1. **好感度检测**：系统检测当前NPC的好感度
2. **提示词选择**：根据好感度区间选择对应的提示词模板
3. **角色性格融合**：结合角色的性格特征
4. **生成回应**：LLM基于提示词生成符合角色的对话

### 提示词配置

配置文件位于：`config/prompts/galgame-prompts.yaml`

**主要部分**：
- **变量定义**：定义好感度、故事阶段等变量
- **提示词模板**：不同好感度区间的提示词
- **组合策略**：如何组合多个提示词

### 自定义提示词

你可以修改配置文件来自定义角色行为：

```yaml
npc_relationship:
  type: "conditional"
  variable: "npc_relationship"
  conditions:
    - range: [51, 75]
      label: "亲密"
      content: |
        ## NPC好感度：亲密
        
        **角色态度**：
        - 对玩家有明显的好感
        - 经常主动寻找接触机会
        
        **对话风格**：
        - 使用亲昵、温柔的语气
        - 经常使用昵称
```

## 特殊事件系统

### 事件触发条件

**好感度事件**：
- 好感度达到80：触发告白事件
- 好感度低于-50：触发警告事件

**角色解锁**：
- 与樱好感度达到30：解锁花

**剧情事件**：
- 特定场景+特定好感度：触发特殊剧情

### 事件类型

1. **对话事件**：特殊的对话内容
2. **场景事件**：场景切换
3. **解锁事件**：解锁新角色或功能
4. **结局事件**：达成特定结局

## 游戏界面说明

### 主界面布局

```
┌─────────────────────────────────────────┐
│  💕 恋爱模拟器    早晨·学校门口    ☰   │  ← 顶部栏
├──────┬──────────────────────────────────┤
│      │                                  │
│ 角色 │         角色立绘区域              │
│ 列表 │                                  │
│      │                                  │
│ 樱   ├──────────────────────────────────┤
│ 雪   │  ┌────────────────────────────┐  │
│ 花   │  │  对话框                     │  │
│      │  │  樱: 你好...（脸红）        │  │
│      │  └────────────────────────────┘  │
│      ├──────────────────────────────────┤
│      │  [输入框] 💬 发送               │  ← 输入区
└──────┴──────────────────────────────────┘
```

### 界面元素

1. **顶部栏**
   - 游戏标题
   - 场景信息（时间、地点）
   - 菜单按钮

2. **角色列表**（左侧）
   - 显示所有角色
   - 已解锁/未解锁状态
   - 当前好感度

3. **角色立绘区**（中央）
   - 显示当前对话角色
   - 角色名称标签

4. **对话框**（下方）
   - 角色名称
   - 好感度指示器
   - 对话内容
   - 输入中提示

5. **输入区**（底部）
   - 文本输入框
   - 发送按钮

6. **状态栏**（最底部）
   - 系统状态
   - 调试按钮

## 开发指南

### 添加新角色

1. **在GameState中定义**（`models/GameState.js`）：

```javascript
this.npcs.set('new_character', {
    id: 'new_character',
    name: '新角色',
    avatar: 'new_character.png',
    relationship: 0,
    personality: 'cool',
    description: '角色描述',
    unlocked: false
});
```

2. **在NPCService中添加模板**（`services/NPCService.js`）：

```javascript
this.npcTemplates.set('new_character', {
    id: 'new_character',
    name: '新角色',
    personality: 'cool',
    traits: { /* 性格特征 */ },
    dialoguePatterns: { /* 对话模式 */ }
});
```

3. **配置提示词**（`config/prompts/galgame-prompts.yaml`）：
   - 根据需要调整提示词内容

### 修改好感度变化规则

在 `controllers/GameController.js` 的 `parseResponse` 方法中：

```javascript
parseResponse(response) {
    // 自定义好感度变化逻辑
    let relationshipChange = 0;
    
    // 根据回应内容判断
    if (response.includes('开心')) {
        relationshipChange = 5;
    } else if (response.includes('生气')) {
        relationshipChange = -3;
    }
    
    return { dialogue, relationshipChange };
}
```

### 添加特殊事件

在 `controllers/GameController.js` 的 `checkSpecialEvents` 方法中：

```javascript
checkSpecialEvents(gameState, npc) {
    // 自定义事件触发条件
    if (npc.relationship >= 60 && !gameState.gameFlags.get('special_event')) {
        gameState.gameFlags.set('special_event', true);
        // 触发事件
    }
}
```

## 故障排查

### 常见问题

**Q: 游戏无法启动**
- 检查是否在正确的环境中运行
- 确认 `callGenerate` 函数可用
- 查看浏览器控制台错误信息

**Q: 角色不回应**
- 检查是否选择了角色
- 确认输入了内容
- 查看网络请求是否成功

**Q: 好感度不变化**
- 检查LLM回应中是否包含好感度标记
- 查看控制台日志
- 确认解析逻辑正常工作

**Q: 动态提示词不生效**
- 检查YAML配置文件是否正确加载
- 确认变量值在定义的范围内
- 查看初始化日志

### 调试模式

按 `Ctrl+D` 打开调试面板，查看：
- 游戏状态
- 事件日志
- 错误信息

## 最佳实践

### 游戏体验

1. **循序渐进**：从普通对话开始，逐步提升好感度
2. **观察反应**：注意角色的回应和好感度变化
3. **角色理解**：了解每个角色的性格特点
4. **适时表达**：在合适的时机表达好感

### 开发建议

1. **提示词设计**：确保不同好感度区间的提示词有明显区别
2. **性格一致性**：保持角色性格的一致性
3. **事件平衡**：合理设置事件触发条件
4. **用户反馈**：提供清晰的好感度变化反馈

## 技术架构

### 核心模块

```
GameCore (核心)
├── EventBus (事件总线)
├── ServiceLocator (服务定位器)
├── GameState (游戏状态)
├── Services (服务层)
│   ├── LLMService (LLM服务)
│   ├── DynamicPromptService (动态提示词)
│   ├── GameStateService (状态管理)
│   └── NPCService (NPC管理)
├── Controllers (控制器)
│   └── GameController (游戏控制)
└── Views (视图)
    └── GameView (游戏视图)
```

### 数据流

```
用户输入 → GameView → GameController
    ↓
获取游戏状态 → 生成动态提示词
    ↓
调用LLM → 解析回应 → 更新好感度
    ↓
更新UI显示 ← GameView ← 事件通知
```

## 扩展功能建议

### 可以添加的功能

1. **存档系统**：保存游戏进度
2. **CG收集**：解锁特殊图片
3. **多结局**：根据好感度达成不同结局
4. **语音系统**：为角色添加语音
5. **背景音乐**：根据场景切换BGM
6. **选项系统**：提供预设的对话选项
7. **成就系统**：完成特定条件获得成就
8. **时间系统**：模拟游戏内的时间流逝

## 总结

这个GalGame Demo展示了如何使用动态提示词系统创建一个基于LLM的恋爱模拟游戏。通过好感度系统和角色性格设定，AI可以生成符合角色特点且随关系变化的对话内容。

核心优势：
- ✅ 动态对话生成
- ✅ 基于好感度的态度变化
- ✅ 多角色支持
- ✅ 可扩展的架构
- ✅ 易于自定义

祝你游戏愉快！💕