<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’• æ‹çˆ±æ¨¡æ‹Ÿå™¨ - GalGame Demo (æœ¬åœ°æµ‹è¯•ç‰ˆ)</title>
    <!-- æœ¬åœ°æµ‹è¯•é…ç½® -->
    <script>
        // æœ¬åœ°æµ‹è¯•é…ç½® - ä½¿ç”¨ç›¸å¯¹è·¯å¾„
        const BASE_URL = './';
        
        window.GameConfig = {
            BASE_URL: BASE_URL,
            CDN_BASE_URL: 'https://cdn.jsdelivr.net/gh/halfmadnya/ST-GalGame@main/',
            isLocalFile: true,
            getPath: function(relativePath) {
                return BASE_URL + relativePath;
            },
            getModulePath: function(modulePath) {
                return BASE_URL + modulePath;
            },
            getConfigPath: function(configPath) {
                return BASE_URL + configPath;
            },
            getStylePath: function(stylePath) {
                return BASE_URL + stylePath;
            }
        };
        
        console.log('[Config] æœ¬åœ°æµ‹è¯•æ¨¡å¼');
        console.log('[Config] Base URL:', BASE_URL);
        
        // åŠ¨æ€åŠ è½½CSS
        (function() {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = './assets/styles/galgame.css';
            document.head.appendChild(link);
        })();
    </script>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>ğŸ’• æ‹çˆ±æ¨¡æ‹Ÿå™¨</h2>
            <p>æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆç³»ç»Ÿ...</p>
            <p style="font-size: 12px; color: #888;">æœ¬åœ°æµ‹è¯•ç‰ˆæœ¬</p>
            <div class="loading-progress">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢å®¹å™¨ï¼Œå°†ç”±GameView.jså¡«å…… -->
    <div id="game-root"></div>

    <!-- é”™è¯¯æ˜¾ç¤ºå®¹å™¨ -->
    <div id="error-container" class="error-container hidden">
        <div class="error-content">
            <h2>ğŸš« æ¸¸æˆå¯åŠ¨å¤±è´¥</h2>
            <p id="error-message"></p>
            <div class="error-details">
                <p>è¯·ç¡®ä¿ï¼š</p>
                <ul>
                    <li>åœ¨æ­£ç¡®çš„iframeç¯å¢ƒä¸­è¿è¡Œ</li>
                    <li>å°ç™½Xæ’ä»¶å·²æ­£ç¡®åŠ è½½</li>
                    <li>callGenerateå‡½æ•°å¯ç”¨</li>
                    <li>æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨æ­£ç¡®çš„ä½ç½®</li>
                </ul>
            </div>
            <button onclick="location.reload()" class="retry-button">é‡è¯•</button>
        </div>
    </div>

    <!-- è°ƒè¯•é¢æ¿ (å¯é€‰) -->
    <div id="debug-panel" class="debug-panel hidden">
        <div class="debug-header">
            <h3>è°ƒè¯•ä¿¡æ¯</h3>
            <button onclick="toggleDebugPanel()" class="debug-close">Ã—</button>
        </div>
        <div class="debug-content">
            <div class="debug-section">
                <h4>æ¸¸æˆçŠ¶æ€</h4>
                <pre id="debug-game-state"></pre>
            </div>
            <div class="debug-section">
                <h4>äº‹ä»¶æ—¥å¿—</h4>
                <div id="debug-event-log" class="debug-log"></div>
            </div>
        </div>
    </div>

    <!-- æ¨¡å—åŒ–JavaScriptåŠ è½½ -->
    <script type="module">
        // åŠ¨æ€åŠ è½½æ¨¡å—å¹¶æ˜¾ç¤ºè¿›åº¦
        const modules = [
            './core/EventBus.js',
            './core/ServiceLocator.js',
            './models/GameState.js',
            './utils/PromptParser.js',
            './services/LLMService.js',
            './services/DynamicPromptService.js',
            './services/GameStateService.js',
            './services/NPCService.js',
            './controllers/GameController.js',
            './views/GameView.js',
            './core/GameCore.js'
        ];

        let loadedCount = 0;
        const progressBar = document.getElementById('loadingBar');

        function updateProgress() {
            loadedCount++;
            const progress = (loadedCount / modules.length) * 100;
            progressBar.style.width = progress + '%';
            
            if (loadedCount === modules.length) {
                // æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆï¼Œå¯åŠ¨æ¸¸æˆ
                setTimeout(() => {
                    import('./index.js');
                }, 500);
            }
        }

        // é¢„åŠ è½½æ‰€æœ‰æ¨¡å—
        modules.forEach(module => {
            console.log('[Loading]', module);
            import(module).then(() => {
                console.log('[Loaded]', module);
                updateProgress();
            }).catch(error => {
                console.error('Failed to load module:', module, error);
                showError(`æ¨¡å—åŠ è½½å¤±è´¥: ${module}\n\né”™è¯¯: ${error.message}`);
            });
        });

        // é”™è¯¯å¤„ç†å‡½æ•°
        function showError(message) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').classList.remove('hidden');
        }

        // è°ƒè¯•é¢æ¿æ§åˆ¶
        window.toggleDebugPanel = function() {
            const panel = document.getElementById('debug-panel');
            panel.classList.toggle('hidden');
        };

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // Ctrl+D å¼€å¯è°ƒè¯•é¢æ¿
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleDebugPanel();
            }
            // ESC å…³é—­è°ƒè¯•é¢æ¿
            if (e.key === 'Escape') {
                document.getElementById('debug-panel').classList.add('hidden');
            }
        });
    </script>
</body>
</html>