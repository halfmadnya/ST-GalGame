<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMé©±åŠ¨RPG Demo - æœ¬åœ°CDNç‰ˆæœ¬</title>
    
    <!-- ä»æœ¬åœ°æœåŠ¡å™¨åŠ è½½CSS -->
    <link rel="stylesheet" href="http://127.0.0.1:5500/assets/styles/game.css">
    <link rel="stylesheet" href="http://127.0.0.1:5500/assets/styles/ui-components.css">
    
    <!-- æ·»åŠ ä¸€äº›åŸºç¡€æ ·å¼ä»¥é˜²CSSåŠ è½½å¤±è´¥ -->
    <style>
        .css-loading-fallback {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1e3c72;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 99999;
        }
        
        .css-loading-fallback h2 {
            margin-bottom: 20px;
        }
        
        .css-loading-fallback p {
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        /* æ£€æµ‹CSSæ˜¯å¦åŠ è½½æˆåŠŸ */
        .css-loaded-indicator {
            display: none;
        }
    </style>
</head>
<body>
    <!-- CSSåŠ è½½å¤±è´¥æ—¶çš„åå¤‡ç•Œé¢ -->
    <div id="cssLoadingFallback" class="css-loading-fallback">
        <h2>ğŸ¨ æ ·å¼æ–‡ä»¶åŠ è½½ä¸­...</h2>
        <p>æ­£åœ¨ä»æœ¬åœ°æœåŠ¡å™¨åŠ è½½CSSæ–‡ä»¶</p>
        <p>æœåŠ¡å™¨åœ°å€: http://127.0.0.1:5500/</p>
        <p>å¦‚æœé•¿æ—¶é—´åœç•™åœ¨æ­¤é¡µé¢ï¼Œè¯·æ£€æŸ¥æœ¬åœ°æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #4CAF50; border: none; color: white; border-radius: 5px; cursor: pointer;">
            é‡æ–°åŠ è½½
        </button>
    </div>

    <!-- ç”¨äºæ£€æµ‹CSSæ˜¯å¦åŠ è½½æˆåŠŸçš„éšè—å…ƒç´  -->
    <div class="css-loaded-indicator"></div>

    <!-- ä¸»åŠ è½½å±å¹• -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>åœ°ç‰¢æ¢é™© Demo</h2>
            <p>æ­£åœ¨ä»æœ¬åœ°CDNåŠ è½½æ¸¸æˆæ¨¡å—...</p>
            <p class="server-info">æœåŠ¡å™¨: http://127.0.0.1:5500/</p>
            <div class="loading-progress">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
            <div class="loading-status" id="loadingStatus">å‡†å¤‡åŠ è½½æ¨¡å—...</div>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢å®¹å™¨ -->
    <div id="game-root"></div>

    <!-- é”™è¯¯æ˜¾ç¤ºå®¹å™¨ -->
    <div id="error-container" class="error-container hidden">
        <div class="error-content">
            <h2>ğŸš« æ¸¸æˆå¯åŠ¨å¤±è´¥</h2>
            <p id="error-message"></p>
            <div class="error-details">
                <p><strong>å¯èƒ½çš„åŸå› ï¼š</strong></p>
                <ul>
                    <li>æœ¬åœ°æœåŠ¡å™¨ (http://127.0.0.1:5500/) æœªè¿è¡Œ</li>
                    <li>æ¨¡å—æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®</li>
                    <li>æµè§ˆå™¨CORSç­–ç•¥é™åˆ¶</li>
                    <li>å°ç™½Xæ’ä»¶æœªæ­£ç¡®åŠ è½½</li>
                    <li>callGenerateå‡½æ•°ä¸å¯ç”¨</li>
                </ul>
                <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                <ul>
                    <li>ç¡®ä¿ä½¿ç”¨VS Code Live Serveræˆ–ç±»ä¼¼å·¥å…·å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨</li>
                    <li>æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æ˜¯å¦åœ¨æ­£ç¡®ä½ç½®</li>
                    <li>ç¡®ä¿åœ¨å°ç™½Xæ’ä»¶çš„iframeç¯å¢ƒä¸­è¿è¡Œ</li>
                </ul>
            </div>
            <div class="error-actions">
                <button onclick="location.reload()" class="retry-button">ğŸ”„ é‡è¯•</button>
                <button onclick="checkServerStatus()" class="retry-button" style="margin-left: 10px;">ğŸ” æ£€æŸ¥æœåŠ¡å™¨</button>
            </div>
        </div>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div id="debug-panel" class="debug-panel hidden">
        <div class="debug-header">
            <h3>ğŸ› è°ƒè¯•ä¿¡æ¯</h3>
            <button onclick="toggleDebugPanel()" class="debug-close">Ã—</button>
        </div>
        <div class="debug-content">
            <div class="debug-section">
                <h4>ğŸ“¡ æœåŠ¡å™¨çŠ¶æ€</h4>
                <div id="debug-server-status">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="debug-section">
                <h4>ğŸ® æ¸¸æˆçŠ¶æ€</h4>
                <pre id="debug-game-state">æœªåˆå§‹åŒ–</pre>
            </div>
            <div class="debug-section">
                <h4>ğŸ“‹ æ¨¡å—åŠ è½½çŠ¶æ€</h4>
                <div id="debug-modules-status"></div>
            </div>
            <div class="debug-section">
                <h4>ğŸ“ äº‹ä»¶æ—¥å¿—</h4>
                <div id="debug-event-log" class="debug-log"></div>
            </div>
        </div>
    </div>

    <!-- æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥å™¨ -->
    <script>
        // æ£€æŸ¥CSSæ˜¯å¦åŠ è½½æˆåŠŸ
        function checkCSSLoaded() {
            const indicator = document.querySelector('.css-loaded-indicator');
            const computedStyle = window.getComputedStyle(indicator);
            
            if (computedStyle.display === 'none') {
                // CSSåŠ è½½æˆåŠŸï¼Œéšè—åå¤‡ç•Œé¢
                document.getElementById('cssLoadingFallback').style.display = 'none';
                return true;
            } else {
                // CSSåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºåå¤‡ç•Œé¢
                document.getElementById('cssLoadingFallback').style.display = 'flex';
                return false;
            }
        }

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            const statusElement = document.getElementById('debug-server-status');
            const serverUrl = 'http://127.0.0.1:5500/';
            
            try {
                statusElement.innerHTML = 'ğŸ”„ æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨...';
                
                // å°è¯•è·å–æ ¹ç›®å½•
                const response = await fetch(serverUrl);
                
                if (response.ok) {
                    statusElement.innerHTML = `
                        <div style="color: #4CAF50;">âœ… æœåŠ¡å™¨æ­£å¸¸</div>
                        <div>çŠ¶æ€ç : ${response.status}</div>
                        <div>æœåŠ¡å™¨: ${serverUrl}</div>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <div style="color: #FF9800;">âš ï¸ æœåŠ¡å™¨å“åº”å¼‚å¸¸</div>
                        <div>çŠ¶æ€ç : ${response.status}</div>
                        <div>æœåŠ¡å™¨: ${serverUrl}</div>
                    `;
                }
            } catch (error) {
                statusElement.innerHTML = `
                    <div style="color: #f44336;">âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥</div>
                    <div>é”™è¯¯: ${error.message}</div>
                    <div>è¯·ç¡®ä¿æœ¬åœ°æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ</div>
                `;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥CSS
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkCSSLoaded, 100);
            
            // å®šæœŸæ£€æŸ¥CSSåŠ è½½çŠ¶æ€
            const cssCheckInterval = setInterval(() => {
                if (checkCSSLoaded()) {
                    clearInterval(cssCheckInterval);
                }
            }, 500);
            
            // 5ç§’ååœæ­¢æ£€æŸ¥
            setTimeout(() => {
                clearInterval(cssCheckInterval);
            }, 5000);
        });
    </script>

    <!-- æ¨¡å—åŒ–JavaScriptåŠ è½½å™¨ -->
    <script type="module">
        // é…ç½®æœ¬åœ°CDNåŸºç¡€URL
        const CDN_BASE_URL = 'http://127.0.0.1:5500/';
        
        // æ¨¡å—åˆ—è¡¨ï¼ŒæŒ‰ä¾èµ–é¡ºåºæ’åˆ—
        const modules = [
            'core/EventBus.js',
            'core/ServiceLocator.js', 
            'models/GameState.js',
            'services/LLMService.js',
            'services/FunctionCallService.js',
            'services/GameStateService.js',
            'controllers/GameController.js',
            'views/GameView.js',
            'core/GameCore.js'
        ];

        let loadedCount = 0;
        const totalModules = modules.length;
        const progressBar = document.getElementById('loadingBar');
        const loadingStatus = document.getElementById('loadingStatus');
        const moduleStatusContainer = document.getElementById('debug-modules-status');

        // åˆå§‹åŒ–æ¨¡å—çŠ¶æ€æ˜¾ç¤º
        function initModuleStatus() {
            if (moduleStatusContainer) {
                moduleStatusContainer.innerHTML = modules.map(module => 
                    `<div id="module-${module.replace(/[/.]/g, '-')}" class="debug-log-entry">â³ ${module}</div>`
                ).join('');
            }
        }

        // æ›´æ–°æ¨¡å—åŠ è½½çŠ¶æ€
        function updateModuleStatus(module, status, error = null) {
            const moduleId = `module-${module.replace(/[/.]/g, '-')}`;
            const element = document.getElementById(moduleId);
            
            if (element) {
                if (status === 'loading') {
                    element.className = 'debug-log-entry info';
                    element.textContent = `ğŸ”„ ${module} - åŠ è½½ä¸­...`;
                } else if (status === 'loaded') {
                    element.className = 'debug-log-entry event';
                    element.textContent = `âœ… ${module} - åŠ è½½æˆåŠŸ`;
                } else if (status === 'error') {
                    element.className = 'debug-log-entry error';
                    element.textContent = `âŒ ${module} - åŠ è½½å¤±è´¥: ${error?.message || 'æœªçŸ¥é”™è¯¯'}`;
                }
            }
        }

        // æ›´æ–°åŠ è½½è¿›åº¦
        function updateProgress(module = null, error = null) {
            loadedCount++;
            const progress = (loadedCount / totalModules) * 100;
            progressBar.style.width = progress + '%';
            
            if (error) {
                loadingStatus.textContent = `âŒ æ¨¡å—åŠ è½½å¤±è´¥: ${module}`;
                loadingStatus.style.color = '#f44336';
            } else if (loadedCount === totalModules) {
                loadingStatus.textContent = 'âœ… æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆï¼Œå¯åŠ¨æ¸¸æˆ...';
                loadingStatus.style.color = '#4CAF50';
                
                // æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆï¼Œå¯åŠ¨æ¸¸æˆ
                setTimeout(() => {
                    startGame();
                }, 500);
            } else {
                loadingStatus.textContent = `â³ å·²åŠ è½½ ${loadedCount}/${totalModules} ä¸ªæ¨¡å—`;
            }
        }

        // å¯åŠ¨æ¸¸æˆ
        async function startGame() {
            try {
                loadingStatus.textContent = 'ğŸ® æ­£åœ¨å¯åŠ¨æ¸¸æˆæ ¸å¿ƒ...';
                
                // å¯¼å…¥å¹¶å¯åŠ¨æ¸¸æˆ
                await import(`${CDN_BASE_URL}index.js`);
                
            } catch (error) {
                console.error('Failed to start game:', error);
                showError(`æ¸¸æˆå¯åŠ¨å¤±è´¥: ${error.message}`);
            }
        }

        // é”™è¯¯å¤„ç†å‡½æ•°
        function showError(message) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').classList.remove('hidden');
        }

        // é¢„åŠ è½½æ‰€æœ‰æ¨¡å—
        async function loadModules() {
            // åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
            initModuleStatus();
            
            loadingStatus.textContent = 'ğŸ”„ å¼€å§‹åŠ è½½æ¨¡å—...';
            
            for (const module of modules) {
                try {
                    updateModuleStatus(module, 'loading');
                    loadingStatus.textContent = `â³ æ­£åœ¨åŠ è½½: ${module}`;
                    
                    await import(`${CDN_BASE_URL}${module}`);
                    
                    updateModuleStatus(module, 'loaded');
                    updateProgress();
                    
                    // æ·»åŠ å°å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°åŠ è½½è¿‡ç¨‹
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.error('Failed to load module:', module, error);
                    updateModuleStatus(module, 'error', error);
                    updateProgress(module, error);
                    showError(`æ¨¡å—åŠ è½½å¤±è´¥: ${module}\né”™è¯¯: ${error.message}`);
                    return;
                }
            }
        }

        // è°ƒè¯•é¢æ¿æ§åˆ¶å‡½æ•°
        window.toggleDebugPanel = function() {
            const panel = document.getElementById('debug-panel');
            panel.classList.toggle('hidden');
            
            // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€
            if (!panel.classList.contains('hidden')) {
                checkServerStatus();
            }
        };

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // Ctrl+D å¼€å¯è°ƒè¯•é¢æ¿
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleDebugPanel();
            }
            // ESC å…³é—­è°ƒè¯•é¢æ¿
            if (e.key === 'Escape') {
                document.getElementById('debug-panel').classList.add('hidden');
            }
        });

        // å¼€å§‹åŠ è½½æµç¨‹
        console.log('ğŸš€ LLM Game Demo - æœ¬åœ°CDNç‰ˆæœ¬å¯åŠ¨');
        console.log('ğŸ“¡ CDN Base URL:', CDN_BASE_URL);
        
        // æ£€æŸ¥æ˜¯å¦åœ¨iframeç¯å¢ƒä¸­
        if (window.self !== window.top) {
            console.log('âœ… è¿è¡Œåœ¨iframeç¯å¢ƒä¸­');
        } else {
            console.warn('âš ï¸ æœªåœ¨iframeç¯å¢ƒä¸­è¿è¡Œï¼Œå¯èƒ½æ— æ³•ä½¿ç”¨å°ç™½Xæ’ä»¶åŠŸèƒ½');
        }
        
        // æ£€æŸ¥callGenerateå‡½æ•°
        if (typeof window.callGenerate === 'function') {
            console.log('âœ… callGenerateå‡½æ•°å¯ç”¨');
        } else {
            console.warn('âš ï¸ callGenerateå‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿åœ¨æ­£ç¡®ç¯å¢ƒä¸­è¿è¡Œ');
        }
        
        // å¼€å§‹æ¨¡å—åŠ è½½
        loadModules();

    </script>

    <!-- é¢å¤–çš„è°ƒè¯•å’Œç›‘æ§è„šæœ¬ -->
    <script>
        // å…¨å±€é”™è¯¯ç›‘å¬
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            
            // å¦‚æœæ˜¯æ¨¡å—åŠ è½½é”™è¯¯ï¼Œæ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯
            if (event.filename && event.filename.includes('127.0.0.1:5500')) {
                const errorMessage = `
                    æ–‡ä»¶åŠ è½½é”™è¯¯: ${event.filename}
                    è¡Œå·: ${event.lineno}
                    é”™è¯¯: ${event.message}
                `;
                
                // æ›´æ–°è°ƒè¯•é¢æ¿
                const debugLog = document.getElementById('debug-event-log');
                if (debugLog) {
                    const entry = document.createElement('div');
                    entry.className = 'debug-log-entry error';
                    entry.textContent = `${new Date().toLocaleTimeString()}: ${errorMessage}`;
                    debugLog.appendChild(entry);
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            }
        });

        // ç›‘å¬æœªå¤„ç†çš„Promiseæ‹’ç»
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            
            const debugLog = document.getElementById('debug-event-log');
            if (debugLog) {
                const entry = document.createElement('div');
                entry.className = 'debug-log-entry error';
                entry.textContent = `${new Date().toLocaleTimeString()}: Promiseæ‹’ç»: ${event.reason}`;
                debugLog.appendChild(entry);
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        });

        // æ€§èƒ½ç›‘æ§
        window.addEventListener('load', () => {
            if (window.performance && window.performance.timing) {
                const timing = window.performance.timing;
                const loadTime = timing.loadEventEnd - timing.navigationStart;
                console.log(`ğŸ“Š é¡µé¢åŠ è½½æ—¶é—´: ${loadTime}ms`);
                
                const debugLog = document.getElementById('debug-event-log');
                if (debugLog) {
                    const entry = document.createElement('div');
                    entry.className = 'debug-log-entry info';
                    entry.textContent = `${new Date().toLocaleTimeString()}: é¡µé¢åŠ è½½å®Œæˆ (${loadTime}ms)`;
                    debugLog.appendChild(entry);
                }
            }
        });

        // å®šæœŸæ£€æŸ¥æœåŠ¡å™¨è¿æ¥çŠ¶æ€
        setInterval(async () => {
            try {
                const response = await fetch('http://127.0.0.1:5500/', { 
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    console.warn('âš ï¸ æœåŠ¡å™¨è¿æ¥å¼‚å¸¸');
                }
            } catch (error) {
                console.error('âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error.message);
            }
        }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

    </script>

    <!-- æ ·å¼å¢å¼ºï¼Œåœ¨CSSæ–‡ä»¶åŠ è½½å¤±è´¥æ—¶æä¾›åŸºç¡€æ ·å¼ -->
    <style>
        /* åå¤‡æ ·å¼ï¼Œé˜²æ­¢CSSæ–‡ä»¶åŠ è½½å¤±è´¥ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .loading-content {
            text-align: center;
            max-width: 400px;
            padding: 40px;
        }
        
        .server-info {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 10px;
        }
        
        .loading-status {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.9;
            min-height: 20px;
        }
        
        .error-actions {
            margin-top: 20px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</body>
</html>